#!/usr/bin/python2.7

from optparse import OptionParser
import logging
from xshop import new
from xshop import config
from xshop import test
import sys
from xshop import colors
def print_general_help():
	print "XSHOP"
	print "\tAvailable Commands:"
	print "\t\tnew\tCreate new project"
	print "\t\tbuild\tBuild packages from source"
	print "\t\ttest\tRun tests"

def print_new_help():
	print "XSHOP - new"
	print "\txshop new [library] [project name]"
	print "\tLibrary name must reflect the name used for source tarballs"
	print "\tProject name is arbitrary"
	
def run_test(source,version):
	d = {'version':version}	
	t = test.TestCase(d,source)

	print colors.colors.BOLD+"Testing: "+colors.colors.ENDC+str(d),
	if t.run():
		print colors.colors.FAIL + "Vulnerable"+colors.colors.ENDC
	else:
		print colors.colors.OKGREEN + "Invulnerable"+colors.colors.ENDC

if len(sys.argv)<2:
	print_general_help()
elif sys.argv[1] =='new':
	if len(sys.argv)<4 or len(sys.argv)>4 or sys.argv[2]=='-h' or sys.argv[2]=='--help':
		print_new_help()
	else:
		library = sys.argv[2]
		project = sys.argv[3]
		print "Building project "+project+" for library "+library+"."
		new.new_test_project(library, project)
elif sys.argv[1] =='test':
	usage = "usage: %prog test [options] [source] [version1] [version2] ...\n\tMust specify at least one version."
	parser = OptionParser(usage=usage)
	parser.add_option("-f","--force", action="store_true", dest="force", help="Force rebuild of any source files.", default=False)
	(options,args) = parser.parse_args(sys.argv[2:])
	if len(args)==0:
		parser.print_help()
		print "Please specify a installation source [source|remote|debian]"
	elif len(args)>=2:
		source = args[0]
		versions = args[1:]
	
	if not source in ['remote','debian','source']:
		parser.print_help()
		print "Source '"+source+"' not recognized."
	else:
		for version in versions:
			run_test(source,version)
			
else:
	print_general_help()
	print "Command '"+sys.argv[1]+"' not recognized."
